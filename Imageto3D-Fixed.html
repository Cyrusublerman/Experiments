<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multifilament Image Print Studio (Fixed)</title>

    <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        :root {
            --bg-app: #f3f4f6; --bg-panel: #ffffff; --border: #e5e7eb;
            --primary: #2563eb; --primary-hover: #1d4ed8;
            --text-main: #1f2937; --text-muted: #6b7280;
            --danger: #ef4444; --warning: #f59e0b;
            --sidebar-w: 380px;
        }

        /* --- GLOBAL LAYOUT --- */
        * { box-sizing: border-box; }
        body { margin: 0; font-family: 'Space Mono', monospace; background: var(--bg-app); color: var(--text-main); height: 100vh; display: flex; flex-direction: column; overflow: hidden; font-size: 12px; }

        header { background: var(--bg-panel); border-bottom: 1px solid var(--border); height: 48px; display: flex; flex-shrink: 0; }
        .tab { flex: 1; display: flex; align-items: center; justify-content: center; cursor: pointer; border-bottom: 3px solid transparent; font-weight: 700; color: var(--text-muted); transition: all 0.2s; max-width: 150px; }
        .tab:hover { background: #f9fafb; color: var(--text-main); }
        .tab.active { border-bottom-color: var(--primary); color: var(--primary); background: #eff6ff; }

        .workspace { display: flex; flex: 1; overflow: hidden; }
        .sidebar { width: var(--sidebar-w); background: var(--bg-panel); border-right: 1px solid var(--border); display: flex; flex-direction: column; overflow-y: auto; padding: 20px; flex-shrink: 0; }

        .sidebar-section { margin-bottom: 24px; border-bottom: 1px solid var(--border); padding-bottom: 20px; }
        .sidebar-section:last-child { border: none; padding-bottom: 0; }
        h3 { font-size: 0.9em; text-transform: uppercase; color: var(--text-muted); margin: 0 0 12px 0; letter-spacing: 0.05em; font-weight: 700; }

        .pane-right { flex: 1; background: #e5e7eb; position: relative; display: flex; flex-direction: column; overflow: hidden; }
        .canvas-area { flex: 1; position: relative; overflow: hidden; display: flex; align-items: center; justify-content: center; background-image: radial-gradient(#cbd5e1 1px, transparent 1px); background-size: 20px 20px; }
        .canvas-wrapper { box-shadow: 0 10px 30px rgba(0,0,0,0.1); background: white; transition: transform 0.1s linear; transform-origin: center; display:flex; align-items:center; justify-content:center;}

        /* --- CONTROLS --- */
        .form-group { margin-bottom: 12px; }
        label { display: block; margin-bottom: 4px; font-weight: 700; font-size: 0.85em; }
        input[type="text"], input[type="number"], select { width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 4px; font-family: inherit; font-size: 1em; background:#fff; }
        input[type="range"] { width: 100%; }

        .btn { display: flex; align-items: center; justify-content: center; padding: 10px; border-radius: 4px; font-weight: 700; cursor: pointer; width: 100%; border: 1px solid transparent; font-family: inherit; margin-top: 8px; font-size: 0.9em; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-hover); }
        .btn-secondary { background: white; border-color: var(--border); color: var(--text-main); }
        .btn-secondary:hover { background: #f9fafb; }
        .btn-tertiary { background: transparent; color: var(--text-muted); padding: 6px; font-size: 0.85em; margin-top:0; }
        .btn-tertiary:hover { color: var(--text-main); text-decoration: underline; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .btn-icon { width: 32px; height: 32px; padding: 0; background: white; border: 1px solid var(--border); border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .btn-icon.active { background: var(--primary); color: white; border-color: var(--primary); }

        /* --- WIDGETS --- */
        .swatch-grid { display: grid; grid-template-columns: repeat(8, 1fr); gap: 4px; max-height: 200px; overflow-y: auto; padding:2px; margin-bottom:10px; }
        .swatch { aspect-ratio: 1; border-radius: 3px; cursor: pointer; border: 1px solid rgba(0,0,0,0.1); position: relative; }
        .swatch.selected { box-shadow: 0 0 0 2px var(--primary); transform: scale(0.9); z-index:2; border-color:white; }

        .selected-list { max-height: 150px; overflow-y: auto; border: 1px solid var(--border); border-radius: 4px; }
        .selected-item { display: flex; align-items: center; padding: 6px; border-bottom: 1px solid var(--border); background: #f9fafb; }
        .selected-item:last-child { border-bottom: none; }
        .color-chip { width: 20px; height: 20px; border-radius: 3px; margin-right: 8px; border: 1px solid #ddd; }

        .z-vis-container { display: flex; align-items: flex-end; height: 100px; background: #f9fafb; border: 1px solid var(--border); padding: 10px; gap: 10px; margin-bottom: 10px; position: relative; }
        .z-stack { width: 40px; display: flex; flex-direction: column-reverse; box-shadow: 2px 2px 5px rgba(0,0,0,0.1); }
        .z-block { width: 100%; border: 1px solid rgba(0,0,0,0.2); }
        .z-base { background: #e5e7eb; border-top: 2px solid #9ca3af; display: flex; align-items: center; justify-content: center; font-size: 0.7em; color: #666; }
        .z-layer { background: var(--primary); opacity: 0.8; height: 8px; margin-bottom: 1px; }

        .alert-box { padding: 10px; border-radius: 4px; margin-top: 10px; font-size: 0.9em; display: flex; align-items: center; gap: 8px; }
        .alert-error { background: #fee2e2; color: #b91c1c; border: 1px solid #fecaca; }

        .list-row { display: flex; align-items: center; gap: 10px; padding: 8px; border: 1px solid var(--border); border-radius: 4px; margin-bottom: 6px; background: #fff; cursor: pointer; }
        .list-row.active { border-color: var(--primary); background: #eff6ff; }
        .thumb { width: 32px; height: 32px; background-size: cover; background-position: center; background-color: #eee; border-radius: 2px; }

        .row { display: flex; gap: 8px; }
        .grow { flex: 1; }
        .hidden { display: none; }
        .overlay-icons { position: absolute; bottom: 20px; right: 20px; display: flex; gap: 8px; z-index: 10; }
        .mode-icons { position: absolute; top: 20px; right: 20px; display: flex; gap: 8px; z-index: 10; }
        .info-card { position: absolute; top: 20px; left: 20px; background: rgba(255,255,255,0.9); padding: 10px; border-radius: 4px; border: 1px solid #ccc; font-size: 0.85em; z-index:10; }
    </style>
</head>
<body>

    <header>
        <div style="width:20px"></div>
        <div class="tab active" data-tab="grid">Grid</div>
        <div class="tab" data-tab="scan">Scan</div>
        <div class="tab" data-tab="process">Process</div>
        <div class="tab" data-tab="model">Model</div>
        <div class="tab" data-tab="export">Export</div>
        <div style="flex:1"></div>
        <div class="tab" style="max-width:60px" data-tab="docs">?</div>
    </header>

    <div class="workspace">

        <div class="sidebar">

            <!-- GRID TAB -->
            <div id="tab-grid" class="tab-content">
                <div class="sidebar-section">
                    <h3>Filament Picker</h3>
                    <div class="form-group">
                        <input type="text" id="search" placeholder="Search filaments...">
                    </div>
                    <div class="swatch-grid" id="swatchGrid"></div>
                    <label>Selected (<span id="selCount">0</span>)</label>
                    <div class="selected-list" id="selectedList"></div>
                </div>

                <div class="sidebar-section">
                    <h3>Constraints</h3>
                    <div class="row">
                        <div class="form-group grow"><label>Bed W</label><input type="number" id="bedW" value="256"></div>
                        <div class="form-group grow"><label>Bed H</label><input type="number" id="bedH" value="256"></div>
                    </div>
                    <div class="row">
                        <div class="form-group grow"><label>Scan W</label><input type="number" id="scanW" value="210"></div>
                        <div class="form-group grow"><label>Scan H</label><input type="number" id="scanH" value="297"></div>
                    </div>
                </div>

                <div class="sidebar-section">
                    <h3>Grid Config</h3>
                    <div class="row">
                        <div class="form-group grow"><label>Tile Size</label><input type="number" id="tileSize" value="10"></div>
                        <div class="form-group grow"><label>Gap</label><input type="number" id="gap" value="1"></div>
                    </div>
                    <div class="z-vis-container">
                        <div class="z-stack" style="height: 100%" id="zStack"></div>
                        <div style="font-size:0.8em; color:#666">
                            Total: <strong id="totalHeight">0.00</strong>mm
                        </div>
                    </div>
                    <div class="row">
                        <div class="form-group grow"><label>Layers/Tile</label><input type="number" id="layers" value="4" min="1"></div>
                        <div class="form-group grow"><label>Layer H</label><input type="number" id="layerH" step="0.04" value="0.08"></div>
                    </div>
                    <div class="form-group"><label>Base Layers</label><input type="number" id="baseLayers" value="3"></div>

                    <div id="gridError" class="alert-box alert-error hidden">
                        <span style="font-size:1.5em">⚠️</span>
                        <div><strong>Error</strong><br><span id="gridErrorMsg"></span></div>
                    </div>
                </div>

                <div class="sidebar-section">
                    <h3>Actions</h3>
                    <button class="btn btn-primary" onclick="app.generateGrid()">Force Regenerate</button>
                    <button class="btn btn-secondary" onclick="app.exportGridJSON()">Export JSON</button>
                    <button class="btn btn-secondary" onclick="app.exportGridImage()">Export Image</button>
                </div>
            </div>

            <!-- SCAN TAB -->
            <div id="tab-scan" class="tab-content hidden">
                <div class="sidebar-section">
                    <h3>Scan List</h3>
                    <button class="btn btn-secondary" onclick="document.getElementById('scanUpload').click()">+ Add Scan</button>
                    <input type="file" id="scanUpload" class="hidden" accept="image/*">
                    <div style="margin-top:10px" id="scanList"></div>
                </div>
                <div class="sidebar-section" id="alignSection" style="display:none">
                    <h3>Alignment</h3>
                    <div class="row">
                        <div class="form-group grow"><label>Off X</label><input type="number" id="offX" value="0"></div>
                        <div class="form-group grow"><label>Off Y</label><input type="number" id="offY" value="0"></div>
                    </div>
                    <div class="row">
                        <div class="form-group grow"><label>Scale X</label><input type="number" id="scaleX" step="0.01" value="1"></div>
                        <div class="form-group grow"><label>Scale Y</label><input type="number" id="scaleY" step="0.01" value="1"></div>
                    </div>
                    <button class="btn btn-secondary" onclick="app.autoAlign()">Auto-Align A4</button>
                </div>
                <div class="sidebar-section" id="analyzeSection" style="display:none">
                    <h3>Analysis</h3>
                    <button class="btn btn-primary" onclick="app.analyzeScan()">Extract Colors</button>
                </div>
            </div>

            <!-- PROCESS TAB -->
            <div id="tab-process" class="tab-content hidden">
                <div class="sidebar-section">
                    <h3>Input</h3>
                    <button class="btn btn-secondary" onclick="document.getElementById('imgUpload').click()">Upload Image</button>
                    <input type="file" id="imgUpload" class="hidden" accept="image/*">
                    <div class="form-group" style="margin-top:10px">
                        <label>Mode</label>
                        <div class="row">
                            <label style="font-weight:400"><input type="radio" name="mode" value="raster" checked> Raster</label>
                            <label style="font-weight:400"><input type="radio" name="mode" value="vector"> Vector</label>
                        </div>
                    </div>
                </div>
                <div id="rasterControls">
                    <div class="sidebar-section">
                        <h3>Raster Config</h3>
                        <div class="form-group"><label>Colors</label><input type="number" id="maxColors" value="4" min="2"></div>
                        <div class="form-group"><label>Noise</label><input type="range" id="noise" min="0" max="50" value="0"></div>
                        <div class="form-group"><label>Dither</label><select id="dither"><option value="none">None</option><option value="floyd" selected>Floyd-Steinberg</option></select></div>
                    </div>
                    <div class="sidebar-section">
                        <button class="btn btn-primary" onclick="app.processRaster()" id="quantBtn" disabled>Quantize</button>
                    </div>
                </div>
            </div>

            <!-- MODEL TAB -->
            <div id="tab-model" class="tab-content hidden">
                <div class="sidebar-section">
                    <h3>Source</h3>
                    <div class="form-group"><label style="font-weight:400"><input type="radio" name="msrc" value="raster" checked> Raster Output</label></div>
                </div>
                <div class="sidebar-section">
                    <h3>Geometry</h3>
                    <div class="form-group"><label>Min Height</label><input type="number" id="minH" step="0.1" value="0.2"></div>
                    <div class="form-group"><label>Max Height</label><input type="number" id="maxH" step="0.1" value="2.0"></div>
                    <div class="form-group"><label><input type="checkbox" id="smoothing"> Smoothing</label></div>
                </div>
                <div class="sidebar-section"><button class="btn btn-primary" onclick="app.generateModel()">Generate Mesh</button></div>
            </div>

            <!-- EXPORT TAB -->
            <div id="tab-export" class="tab-content hidden">
                <div class="sidebar-section">
                    <h3>Export</h3>
                    <div class="form-group"><label><input type="checkbox" checked disabled> Binary STL</label></div>
                    <div class="form-group"><label><input type="checkbox" id="exportPalette"> Palette JSON</label></div>
                    <button class="btn btn-primary" onclick="app.runExport()" id="exportBtn" disabled>Download STL</button>
                </div>
            </div>

            <!-- DOCS TAB -->
            <div id="tab-docs" class="tab-content hidden">
                <div class="sidebar-section">
                    <h3>Help</h3>
                    <button class="btn btn-tertiary">Grid</button>
                    <button class="btn btn-tertiary">Scan</button>
                </div>
            </div>
        </div>

        <div class="pane-right">

            <div id="docs-area" class="canvas-area hidden" style="display:block; overflow-y:auto; padding:40px; background:white">
                <h1>Documentation</h1>
                <section><h2>Grid</h2><p>Select filaments, check dimensions, generate grid.</p></section>
                <section><h2>Scan</h2><p>Upload scan, align grid, extract colors.</p></section>
            </div>

            <div id="canvas-area" class="canvas-area">
                <div class="canvas-wrapper" id="canvasWrapper">
                    <canvas id="gridCanvas" class="hidden"></canvas>
                    <canvas id="scanCanvas" class="hidden"></canvas>
                    <canvas id="procCanvas" class="hidden"></canvas>
                </div>
            </div>

            <div class="info-card hidden" id="infoCard">
                <div style="font-weight:700; border-bottom:1px solid #ccc">Metrics</div>
                <div>Seqs: <span id="metricSeqs">0</span></div>
                <div>Size: <span id="metricSize">0x0mm</span></div>
            </div>

            <div class="mode-icons hidden" id="modeIcons">
                <button class="btn-icon active" onclick="app.toggleView('orig')">O</button>
                <button class="btn-icon" onclick="app.toggleView('res')">R</button>
            </div>

            <div class="overlay-icons" id="overlayIcons">
                <button class="btn-icon" onclick="app.zoom(0.1)">+</button>
                <button class="btn-icon" onclick="app.zoom(-0.1)">-</button>
                <button class="btn-icon" onclick="app.resetView()">R</button>
            </div>
        </div>
    </div>

    <script type="module">
        import * as HFL from './lib/index.js';

        const COLOURS = HFL.COLOURS;

        window.app = {
            // State
            activeTab: 'grid',
            selectedFilaments: [],
            gridData: null,
            sequenceMap: null,
            scans: [],
            activeScanIdx: 0,
            procImg: null,
            processedData: null,
            palette: null,
            layerMaps: null,
            meshReady: false,

            // View
            view: { x: 0, y: 0, scale: 1, dragging: false, lx: 0, ly: 0 },
            procView: 'res',

            init() {
                this.setupTabs();
                this.renderSwatches();
                this.setupEventListeners();
                this.updateZStack();
                this.resetView();
            },

            setupTabs() {
                document.querySelectorAll('.tab[data-tab]').forEach(tab => {
                    tab.addEventListener('click', () => {
                        this.switchTab(tab.dataset.tab);
                    });
                });
            },

            switchTab(tabId) {
                this.activeTab = tabId;

                // Update tab UI
                document.querySelectorAll('.tab[data-tab]').forEach(t => {
                    t.classList.toggle('active', t.dataset.tab === tabId);
                });

                // Update content visibility
                document.querySelectorAll('.tab-content').forEach(c => {
                    c.classList.add('hidden');
                });
                const tabContent = document.getElementById(`tab-${tabId}`);
                if (tabContent) tabContent.classList.remove('hidden');

                // Update canvas visibility
                document.getElementById('gridCanvas').classList.toggle('hidden', tabId !== 'grid');
                document.getElementById('scanCanvas').classList.toggle('hidden', tabId !== 'scan');
                document.getElementById('procCanvas').classList.toggle('hidden', tabId !== 'process');

                // Update overlay visibility
                document.getElementById('overlayIcons').classList.toggle('hidden', tabId === 'docs');
                document.getElementById('canvas-area').classList.toggle('hidden', tabId === 'docs');
                document.getElementById('docs-area').classList.toggle('hidden', tabId !== 'docs');
                document.getElementById('infoCard').classList.toggle('hidden', tabId !== 'grid' || !this.gridData);
                document.getElementById('modeIcons').classList.toggle('hidden', tabId !== 'process');

                setTimeout(() => this.resetView(), 10);
            },

            renderSwatches(filter = '') {
                const grid = document.getElementById('swatchGrid');
                grid.innerHTML = '';
                const filtered = filter ?
                    COLOURS.filter(c => c.n.toLowerCase().includes(filter.toLowerCase())) :
                    COLOURS;

                filtered.forEach(color => {
                    const swatch = document.createElement('div');
                    swatch.className = 'swatch';
                    swatch.style.background = color.h;
                    swatch.title = color.n;
                    swatch.onclick = () => this.toggleFilament(color);
                    if (this.selectedFilaments.find(f => f.h === color.h)) {
                        swatch.classList.add('selected');
                    }
                    grid.appendChild(swatch);
                });
            },

            toggleFilament(color) {
                const idx = this.selectedFilaments.findIndex(f => f.h === color.h);
                if (idx >= 0) {
                    this.selectedFilaments.splice(idx, 1);
                } else if (this.selectedFilaments.length < 10) {
                    this.selectedFilaments.push(color);
                }
                this.updateSelection();
                this.debounceGenerate();
            },

            updateSelection() {
                document.getElementById('selCount').textContent = this.selectedFilaments.length;
                this.renderSwatches(document.getElementById('search').value);

                const list = document.getElementById('selectedList');
                list.innerHTML = '';
                this.selectedFilaments.forEach(f => {
                    const item = document.createElement('div');
                    item.className = 'selected-item';
                    item.innerHTML = `
                        <div class="color-chip" style="background:${f.h}"></div>
                        <div style="flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${f.n}</div>
                        <button style="background:none; border:none; color:red; cursor:pointer" onclick="app.toggleFilament(${JSON.stringify(f).replace(/"/g, '&quot;')})">×</button>
                    `;
                    list.appendChild(item);
                });
            },

            debounceTimer: null,
            debounceGenerate() {
                clearTimeout(this.debounceTimer);
                this.debounceTimer = setTimeout(() => this.generateGrid(), 500);
            },

            updateZStack() {
                const layers = parseInt(document.getElementById('layers').value) || 4;
                const layerH = parseFloat(document.getElementById('layerH').value) || 0.08;
                const baseLayers = parseInt(document.getElementById('baseLayers').value) || 3;

                const stack = document.getElementById('zStack');
                stack.innerHTML = `
                    <div class="z-block z-base" style="flex: 0 0 ${baseLayers * layerH * 20}px">Base</div>
                    ${Array(layers).fill(0).map(() => `<div class="z-block z-layer" style="flex: 0 0 ${layerH * 20}px"></div>`).join('')}
                `;

                const total = (baseLayers * layerH) + (layers * layerH);
                document.getElementById('totalHeight').textContent = total.toFixed(2);
            },

            generateGrid() {
                if (this.selectedFilaments.length < 2) return;

                const config = {
                    bedW: +document.getElementById('bedW').value,
                    bedH: +document.getElementById('bedH').value,
                    scanW: +document.getElementById('scanW').value,
                    scanH: +document.getElementById('scanH').value,
                    tileSize: +document.getElementById('tileSize').value,
                    gap: +document.getElementById('gap').value,
                    layers: +document.getElementById('layers').value
                };

                const sequences = HFL.generateSequences(this.selectedFilaments.length, config.layers);
                const constraints = HFL.calculateConstraints({
                    bedW: config.bedW, bedH: config.bedH,
                    scanW: config.scanW, scanH: config.scanH
                });
                const layout = HFL.calculateGridLayout({
                    sequenceCount: sequences.length,
                    tileSize: config.tileSize,
                    gap: config.gap,
                    maxWidth: constraints.maxWidth,
                    maxHeight: constraints.maxHeight
                });

                const errorBox = document.getElementById('gridError');
                const errorMsg = document.getElementById('gridErrorMsg');

                if (!layout.fits) {
                    errorBox.classList.remove('hidden');
                    errorMsg.textContent = layout.error;
                    return;
                } else {
                    errorBox.classList.add('hidden');
                }

                this.gridData = {
                    sequences,
                    colours: this.selectedFilaments,
                    rows: layout.rows,
                    cols: layout.cols,
                    tileSize: config.tileSize,
                    gap: config.gap,
                    width: layout.width,
                    height: layout.height,
                    emptyCells: layout.emptyCells
                };

                this.sequenceMap = HFL.buildSequenceMap(sequences, this.selectedFilaments, layout.cols);

                this.drawGridCanvas();

                document.getElementById('infoCard').classList.remove('hidden');
                document.getElementById('metricSeqs').textContent = sequences.length;
                document.getElementById('metricSize').textContent = `${layout.width.toFixed(1)}x${layout.height.toFixed(1)}mm`;

                this.resetView();
            },

            drawGridCanvas() {
                const canvas = document.getElementById('gridCanvas');
                HFL.drawGrid(canvas, this.gridData, { scale: 5, padding: 20 });
                canvas.classList.remove('hidden');
            },

            exportGridJSON() {
                if (!this.gridData) return;
                const json = HFL.exportGridJSON(this.gridData, {
                    layers: +document.getElementById('layers').value,
                    layerHeight: +document.getElementById('layerH').value,
                    baseLayers: +document.getElementById('baseLayers').value
                });
                saveAs(new Blob([json], {type: 'application/json'}), 'grid.json');
            },

            exportGridImage() {
                if (!this.gridData) return;
                document.getElementById('gridCanvas').toBlob(b => saveAs(b, 'grid.png'));
            },

            // View controls
            zoom(delta) {
                this.view.scale = Math.max(0.1, this.view.scale + delta);
                this.updateTransform();
            },

            resetView() {
                this.view.scale = 0.8;
                this.view.x = 0;
                this.view.y = 0;
                this.updateTransform();
            },

            updateTransform() {
                const wrapper = document.getElementById('canvasWrapper');
                wrapper.style.transform = `translate(${this.view.x}px, ${this.view.y}px) scale(${this.view.scale})`;
            },

            setupEventListeners() {
                const pane = document.querySelector('.pane-right');

                pane.addEventListener('mousedown', (e) => {
                    if (e.target.closest('.btn-icon, .info-card')) return;
                    this.view.dragging = true;
                    this.view.lx = e.clientX;
                    this.view.ly = e.clientY;
                });

                pane.addEventListener('mousemove', (e) => {
                    if (this.view.dragging) {
                        this.view.x += e.clientX - this.view.lx;
                        this.view.y += e.clientY - this.view.ly;
                        this.view.lx = e.clientX;
                        this.view.ly = e.clientY;
                        this.updateTransform();
                    }
                });

                pane.addEventListener('mouseup', () => {
                    this.view.dragging = false;
                });

                pane.addEventListener('wheel', (e) => {
                    e.preventDefault();
                    this.zoom(e.deltaY > 0 ? -0.1 : 0.1);
                });

                document.getElementById('search').addEventListener('input', (e) => {
                    this.renderSwatches(e.target.value);
                });

                ['layers', 'layerH', 'baseLayers'].forEach(id => {
                    document.getElementById(id).addEventListener('input', () => {
                        this.updateZStack();
                        this.debounceGenerate();
                    });
                });

                ['bedW', 'bedH', 'scanW', 'scanH', 'tileSize', 'gap'].forEach(id => {
                    document.getElementById(id).addEventListener('input', () => {
                        this.debounceGenerate();
                    });
                });

                document.getElementById('scanUpload').addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    const img = new Image();
                    img.onload = () => {
                        this.scans.push({ name: file.name, img, url: img.src, offX: 0, offY: 0, scaleX: 1, scaleY: 1 });
                        this.activeScanIdx = this.scans.length - 1;
                        this.drawScan();
                        document.getElementById('alignSection').style.display = 'block';
                        document.getElementById('analyzeSection').style.display = 'block';
                    };
                    img.src = URL.createObjectURL(file);
                });

                document.getElementById('imgUpload').addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    const img = new Image();
                    img.onload = () => {
                        this.procImg = img;
                        document.getElementById('quantBtn').disabled = false;
                        this.drawProcImage();
                    };
                    img.src = URL.createObjectURL(file);
                });
            },

            drawScan() {
                const scan = this.scans[this.activeScanIdx];
                if (!scan) return;

                const canvas = document.getElementById('scanCanvas');
                canvas.width = scan.img.width;
                canvas.height = scan.img.height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(scan.img, 0, 0);

                if (this.gridData) {
                    ctx.save();
                    ctx.translate(scan.offX, scan.offY);
                    ctx.scale(scan.scaleX, scan.scaleY);
                    ctx.strokeStyle = 'rgba(255,0,0,0.5)';
                    ctx.lineWidth = 5;
                    const rW = this.gridData.width * (scan.img.width / +document.getElementById('scanW').value);
                    const rH = this.gridData.height * (scan.img.height / +document.getElementById('scanH').value);
                    ctx.strokeRect(0, 0, rW, rH);
                    ctx.restore();
                }

                canvas.classList.remove('hidden');
                this.resetView();
            },

            autoAlign() {
                if (this.scans[this.activeScanIdx]) {
                    this.scans[this.activeScanIdx].offX = 100;
                    this.scans[this.activeScanIdx].offY = 100;
                    this.scans[this.activeScanIdx].scaleX = 0.9;
                    this.scans[this.activeScanIdx].scaleY = 0.9;
                    this.drawScan();
                }
            },

            analyzeScan() {
                const scan = this.scans[this.activeScanIdx];
                if (!scan || !this.gridData) return;

                const canvas = document.createElement('canvas');
                canvas.width = scan.img.width;
                canvas.height = scan.img.height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(scan.img, 0, 0);

                const alignment = HFL.autoCalculateScale(
                    canvas.width, canvas.height,
                    this.gridData.width, this.gridData.height
                );
                alignment.offsetX = scan.offX;
                alignment.offsetY = scan.offY;

                const { palette } = HFL.extractColors(canvas, this.gridData, alignment);
                this.palette = palette;

                alert(`Extracted ${palette.length} colors`);
            },

            drawProcImage() {
                const canvas = document.getElementById('procCanvas');
                if (this.procView === 'orig' && this.procImg) {
                    canvas.width = this.procImg.width;
                    canvas.height = this.procImg.height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(this.procImg, 0, 0);
                } else if (this.procView === 'res' && this.processedData) {
                    canvas.width = this.processedData.width;
                    canvas.height = this.processedData.height;
                    const ctx = canvas.getContext('2d');
                    ctx.putImageData(this.processedData, 0, 0);
                }
                canvas.classList.remove('hidden');
                this.resetView();
            },

            toggleView(view) {
                this.procView = view;
                this.drawProcImage();
                document.querySelectorAll('#modeIcons .btn-icon').forEach((btn, i) => {
                    btn.classList.toggle('active', (i === 0 && view === 'orig') || (i === 1 && view === 'res'));
                });
            },

            processRaster() {
                if (!this.procImg || !this.palette) return;

                const canvas = document.createElement('canvas');
                canvas.width = this.procImg.width;
                canvas.height = this.procImg.height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(this.procImg, 0, 0);

                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const maxColors = +document.getElementById('maxColors').value;
                const palette = this.palette.slice(0, maxColors);
                const dither = document.getElementById('dither').value === 'floyd';

                HFL.quantizeImage(imageData, palette, { dither });

                this.processedData = imageData;
                this.layerMaps = HFL.expandToLayers(imageData, this.sequenceMap, this.selectedFilaments.length);

                this.procView = 'res';
                this.drawProcImage();

                document.getElementById('exportBtn').disabled = false;
            },

            generateModel() {
                alert('Model generation not yet implemented');
            },

            runExport() {
                if (!this.layerMaps) return;

                const filamentNames = this.selectedFilaments.map(c => c.n);
                const stls = HFL.exportArtworkSTLs(this.layerMaps, filamentNames, {
                    imageWidth: this.processedData.width,
                    imageHeight: this.processedData.height,
                    printWidth: 170,
                    layerHeight: +document.getElementById('layerH').value
                });

                Object.entries(stls).forEach(([filename, content]) => {
                    saveAs(new Blob([content], {type: 'text/plain'}), filename);
                });

                alert(`Exported ${Object.keys(stls).length} STL files`);
            }
        };

        // Initialize
        window.app.init();
    </script>
</body>
</html>
