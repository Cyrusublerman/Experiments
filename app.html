<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>4-Colour FDM Workflow</title>
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="app-styles.css">
</head>
<body>

<!-- TAB BAR -->
<nav class="tab-bar">
  <button class="tab-btn active" data-tab="grid">Grid</button>
  <button class="tab-btn" data-tab="scan">Scan</button>
  <button class="tab-btn" data-tab="image-process">Image Process</button>
  <button class="tab-btn" data-tab="model-builder">Model Builder</button>
  <button class="tab-btn" data-tab="export">Export</button>
  <button class="tab-btn" data-tab="docs">Docs</button>
</nav>

<!-- TAB 1: GRID -->
<div class="tab-view active" id="tab-grid">
  <div class="left-column">

    <!-- Filament Picker -->
    <section class="control-group">
      <h3>Filament Picker</h3>
      <div class="selected-colours-row" id="selectedColoursRow">
        <span class="placeholder">Select 2-10 filaments below</span>
      </div>
      <input type="text" class="search-bar" placeholder="Search filaments..." id="filamentSearch">
      <div class="filament-swatch-grid" id="filamentGrid"></div>
    </section>

    <!-- Physical Constraints -->
    <section class="control-group">
      <h3>Physical Constraints</h3>
      <div class="form-row">
        <label>Bed Width (mm)</label>
        <input type="number" id="bedW" value="256" min="100">
      </div>
      <div class="form-row">
        <label>Bed Height (mm)</label>
        <input type="number" id="bedH" value="256" min="100">
      </div>
      <div class="form-row">
        <label>Scan Width (mm)</label>
        <input type="number" id="scanW" value="210" min="100">
      </div>
      <div class="form-row">
        <label>Scan Height (mm)</label>
        <input type="number" id="scanH" value="297" min="100">
      </div>
    </section>

    <!-- Grid Z-Config -->
    <section class="control-group">
      <h3>Grid Z-Config</h3>
      <div class="form-row">
        <label>Layers per Tile</label>
        <input type="number" id="layersPerTile" value="4" min="1" max="10">
      </div>
      <div class="form-row">
        <label>Layer Height (mm)</label>
        <input type="number" id="layerH" value="0.08" min="0.04" max="0.4" step="0.01">
      </div>
      <div class="form-row">
        <label>Base Layers</label>
        <input type="number" id="baseLayers" value="3" min="0" max="10">
      </div>
      <div class="form-row">
        <label>Base Layer Colour</label>
        <select id="baseColour">
          <option value="-1">White (default)</option>
        </select>
      </div>
      <div class="visualisation-box" id="zConfigViz">
        <span class="placeholder">Side-view visualization</span>
      </div>
    </section>

    <!-- Grid XY-Config -->
    <section class="control-group">
      <h3>Grid XY-Config</h3>
      <div class="form-row">
        <label>Tile Size (mm)</label>
        <input type="number" id="tileSize" value="10" min="2" max="20" step="0.5">
      </div>
      <div class="form-row">
        <label>Gap Size (mm)</label>
        <input type="number" id="gapSize" value="1" min="0" max="5" step="0.5">
      </div>
      <div class="form-row">
        <label>
          <input type="checkbox" id="baseFill" checked>
          Base Fill
        </label>
      </div>
      <div class="form-row">
        <label>Multi-page Options</label>
        <input type="number" id="pageCount" value="1" min="1" max="10" placeholder="Page count">
      </div>
      <div class="visualisation-box" id="xyConfigViz">
        <span class="placeholder">Top-down visualization</span>
      </div>
    </section>

    <!-- Actions -->
    <section class="control-group">
      <h3>Actions</h3>
      <button class="btn-primary" id="generateGrid">Generate Grid</button>
      <div class="btn-group">
        <button class="btn-secondary" id="exportGridJSON">Export Grid JSON</button>
        <button class="btn-secondary" id="importGridJSON">Import Grid JSON</button>
        <button class="btn-secondary" id="exportGridSTLs">Export STLs</button>
        <button class="btn-secondary" id="exportRefImage">Export Reference Image</button>
      </div>
    </section>

  </div>

  <div class="right-pane">
    <div class="canvas-container">
      <canvas id="gridCanvas"></canvas>
      <div class="icon-btn-cluster">
        <button class="btn-icon" title="Zoom In" id="gridZoomIn">+</button>
        <button class="btn-icon" title="Zoom Out" id="gridZoomOut">−</button>
        <button class="btn-icon" title="Reset" id="gridReset">⟲</button>
      </div>
      <button class="btn-info" title="Help">?</button>
    </div>
    <div class="stats-row" id="gridStats">
      <div class="stat"><span class="stat-label">Sequences</span><span class="stat-value" id="statSeqs">0</span></div>
      <div class="stat"><span class="stat-label">Rows</span><span class="stat-value" id="statRows">0</span></div>
      <div class="stat"><span class="stat-label">Columns</span><span class="stat-value" id="statCols">0</span></div>
      <div class="stat"><span class="stat-label">Size</span><span class="stat-value" id="statSize">0×0mm</span></div>
    </div>
  </div>
</div>

<!-- TAB 2: SCAN -->
<div class="tab-view" id="tab-scan">
  <div class="left-column">

    <!-- Scan List -->
    <section class="control-group">
      <h3>Scan List</h3>
      <button class="btn-secondary" id="addScan">+ Add Scan</button>
      <input type="file" id="scanFileInput" accept="image/*" style="display:none">
      <div class="scan-list" id="scanList">
        <p class="placeholder">No scans loaded</p>
      </div>
    </section>

    <!-- Alignment -->
    <section class="control-group">
      <h3>Alignment</h3>
      <div class="form-row">
        <label>Offset X (px)</label>
        <input type="number" id="alignOffsetX" value="0" step="1">
      </div>
      <div class="form-row">
        <label>Offset Y (px)</label>
        <input type="number" id="alignOffsetY" value="0" step="1">
      </div>
      <div class="form-row">
        <label>Scale X</label>
        <input type="number" id="alignScaleX" value="1" step="0.01" min="0.1" max="5">
      </div>
      <div class="form-row">
        <label>Scale Y</label>
        <input type="number" id="alignScaleY" value="1" step="0.01" min="0.1" max="5">
      </div>
      <div class="form-row">
        <label>Dead Space (%)</label>
        <input type="number" id="deadSpace" value="60" min="20" max="90">
      </div>
      <div class="btn-group">
        <button class="btn-secondary" id="autoAlign">Auto-Align</button>
        <button class="btn-tertiary" id="resetAlignment">Reset Alignment</button>
      </div>
    </section>

    <!-- Analysis -->
    <section class="control-group">
      <h3>Analysis</h3>
      <button class="btn-primary" id="analyseExtractPalette">Analyse & Extract Palette</button>
      <div class="btn-group">
        <button class="btn-secondary" id="exportAlignJSON">Export Alignment JSON</button>
        <button class="btn-tertiary" id="removeDuplicates">Remove Duplicates</button>
      </div>
    </section>

  </div>

  <div class="right-pane">
    <div class="canvas-container">
      <canvas id="scanCanvas"></canvas>
      <div class="icon-btn-cluster">
        <button class="btn-icon" title="Zoom In" id="scanZoomIn">+</button>
        <button class="btn-icon" title="Zoom Out" id="scanZoomOut">−</button>
        <button class="btn-icon" title="Toggle Overlay" id="scanToggleOverlay">⊞</button>
        <button class="btn-icon" title="Reset" id="scanReset">⟲</button>
      </div>
      <button class="btn-info" title="Help">?</button>
    </div>
    <div class="palette-strip" id="paletteStrip">
      <p class="placeholder">Palette will appear after analysis</p>
    </div>
    <div class="summary-metrics" id="scanMetrics">
      <div class="metric"><span class="metric-label">Scanned</span><span class="metric-value" id="metricScanned">0</span></div>
      <div class="metric"><span class="metric-label">Unique</span><span class="metric-value" id="metricUnique">0</span></div>
      <div class="metric"><span class="metric-label">Duplicates</span><span class="metric-value" id="metricDups">0</span></div>
      <div class="metric"><span class="metric-label">px/mm</span><span class="metric-value" id="metricPxMm">—</span></div>
    </div>
  </div>
</div>

<!-- TAB 3: IMAGE PROCESS -->
<div class="tab-view" id="tab-image-process">
  <div class="left-column">

    <!-- File Import -->
    <section class="control-group">
      <h3>File Import</h3>
      <div class="upload-zone" id="imageUploadZone">
        <p>Drag & drop image or click to upload</p>
        <input type="file" id="imageFileInput" accept="image/*,.svg" style="display:none">
      </div>
      <div class="mode-display" id="modeDisplay">
        <span class="mode-badge" id="modeBadge">Mode: Auto-detect</span>
        <div class="mode-toggle">
          <button class="btn-text" id="toggleToRaster">Raster</button>
          <button class="btn-text" id="toggleToVector">Vector</button>
        </div>
      </div>
    </section>

    <!-- Raster Mode Controls -->
    <section class="control-group mode-raster" id="rasterControls">
      <h3>Raster Mode</h3>
      <div class="form-row">
        <label>Palette Source</label>
        <label><input type="radio" name="paletteSrc" value="extracted" checked> Extracted (from scan)</label>
        <label><input type="radio" name="paletteSrc" value="imported"> Import GPL</label>
        <button class="btn-secondary" id="importGPL">Import GPL File</button>
        <input type="file" id="gplFileInput" accept=".gpl" style="display:none">
      </div>
      <div class="form-row">
        <label>Max Colours</label>
        <input type="number" id="maxColours" value="4" min="2" max="340">
      </div>
      <div class="form-row">
        <label>Min Detail (mm)</label>
        <input type="number" id="minDetail" value="1.0" min="0.1" max="10" step="0.1">
      </div>
      <div class="form-row">
        <label><input type="checkbox" id="dithering" checked> Floyd-Steinberg Dithering</label>
      </div>
      <div class="form-row">
        <label>Edge Threshold</label>
        <input type="range" id="edgeThreshold" min="0" max="255" value="128">
      </div>
      <div class="form-row">
        <label><input type="checkbox" id="autoUpdate"> Auto-update Preview</label>
      </div>
      <button class="btn-primary" id="quantiseImage">Quantise Image</button>
      <button class="btn-tertiary" id="resetRaster">Reset Settings</button>
    </section>

    <!-- Vector Mode Controls -->
    <section class="control-group mode-vector hidden" id="vectorControls">
      <h3>Vector Mode</h3>
      <div class="form-row">
        <label>Simplify Tolerance</label>
        <input type="number" id="simplifyTol" value="1.0" min="0" max="10" step="0.1">
      </div>
      <div class="form-row">
        <label>Merge Adjacent Paths</label>
        <input type="checkbox" id="mergePaths" checked>
      </div>
      <div class="form-row">
        <label>Convert Stroke to Fill</label>
        <input type="checkbox" id="strokeToFill">
      </div>
      <div class="form-row">
        <label>Colour Threshold</label>
        <input type="range" id="colourThreshold" min="0" max="100" value="10">
      </div>
      <button class="btn-primary" id="processVector">Process Vector</button>
      <button class="btn-tertiary" id="resetVector">Reset Settings</button>
    </section>

  </div>

  <div class="right-pane">
    <div class="canvas-container">
      <canvas id="imageProcessCanvas"></canvas>
      <div class="icon-btn-cluster">
        <button class="btn-icon" title="Show Original" id="showOriginal">O</button>
        <button class="btn-icon" title="Show Processed" id="showProcessed">P</button>
        <button class="btn-icon" title="Zoom In" id="imgZoomIn">+</button>
        <button class="btn-icon" title="Zoom Out" id="imgZoomOut">−</button>
        <button class="btn-icon" title="Reset" id="imgReset">⟲</button>
      </div>
      <button class="btn-info" title="Help">?</button>
    </div>
  </div>
</div>

<!-- TAB 4: MODEL BUILDER -->
<div class="tab-view" id="tab-model-builder">
  <div class="left-column">

    <!-- Input Source -->
    <section class="control-group">
      <h3>Input Source</h3>
      <label><input type="radio" name="modelSrc" value="raster" checked> Raster Output</label>
      <label><input type="radio" name="modelSrc" value="vector"> Vector Output</label>
      <label><input type="radio" name="modelSrc" value="grid"> Grid Test</label>
    </section>

    <!-- Geometry Options (Raster) -->
    <section class="control-group geom-raster" id="geomRaster">
      <h3>Geometry (Raster)</h3>
      <div class="form-row">
        <label>Height Scale</label>
        <input type="number" id="heightScale" value="1.0" min="0.1" max="10" step="0.1">
      </div>
      <div class="form-row">
        <label>Min Height (mm)</label>
        <input type="number" id="minHeight" value="0.2" min="0.04" max="5" step="0.01">
      </div>
      <div class="form-row">
        <label><input type="checkbox" id="smoothing"> Enable Smoothing</label>
      </div>
    </section>

    <!-- Geometry Options (Vector) -->
    <section class="control-group geom-vector hidden" id="geomVector">
      <h3>Geometry (Vector)</h3>
      <div class="form-row">
        <label>Extrusion Depth (mm)</label>
        <input type="number" id="extrusionDepth" value="0.2" min="0.04" max="10" step="0.01">
      </div>
      <div class="form-row">
        <label>Bevel Size</label>
        <input type="number" id="bevelSize" value="0" min="0" max="2" step="0.05">
      </div>
    </section>

    <!-- General Options -->
    <section class="control-group">
      <h3>General</h3>
      <div class="form-row">
        <label>Merge Strategy</label>
        <select id="mergeStrategy">
          <option value="none">No Merge</option>
          <option value="colour">Merge by Colour</option>
          <option value="layer">Merge by Layer</option>
        </select>
      </div>
      <div class="form-row">
        <label>Mesh Mapping</label>
        <select id="meshMapping">
          <option value="colour">One Mesh per Colour</option>
          <option value="layer">One Mesh per Layer</option>
        </select>
      </div>
    </section>

    <!-- Actions -->
    <section class="control-group">
      <h3>Actions</h3>
      <button class="btn-primary" id="generateModel">Generate Model</button>
      <button class="btn-secondary" id="resetModel">Reset Model</button>
    </section>

  </div>

  <div class="right-pane">
    <div class="viewer-container" id="modelViewer">
      <model-viewer id="viewer3d" camera-controls touch-action="pan-y"></model-viewer>
      <div class="icon-btn-cluster">
        <button class="btn-icon" title="Front View" id="viewFront">F</button>
        <button class="btn-icon" title="Top View" id="viewTop">T</button>
        <button class="btn-icon" title="Side View" id="viewSide">S</button>
        <button class="btn-icon" title="Toggle Grid" id="toggleGrid">⊞</button>
      </div>
      <button class="btn-info" title="Help">?</button>
    </div>
    <div class="mesh-list" id="meshList">
      <h4>Meshes</h4>
      <div class="mesh-items" id="meshItems">
        <p class="placeholder">No model generated yet</p>
      </div>
    </div>
  </div>
</div>

<!-- TAB 5: EXPORT -->
<div class="tab-view" id="tab-export">
  <div class="left-column">

    <!-- Export Options -->
    <section class="control-group">
      <h3>Export Options</h3>
      <label><input type="checkbox" id="expSTLPerColour" checked> STL per Colour</label>
      <label><input type="checkbox" id="expSTLPerLayer"> STL per Layer</label>
      <label><input type="checkbox" id="expSTLMerged"> Merged STL</label>
      <label><input type="checkbox" id="exp3MF"> 3MF Format</label>
      <label><input type="checkbox" id="expPaletteJSON" checked> Palette JSON</label>
      <label><input type="checkbox" id="expGridJSON"> Grid JSON</label>
      <label><input type="checkbox" id="expLogs"> Export Logs</label>
    </section>

    <!-- Actions -->
    <section class="control-group">
      <h3>Actions</h3>
      <button class="btn-primary" id="runExport">Run Export</button>
      <button class="btn-secondary" id="exportProjectArchive">Export Project Archive</button>
    </section>

  </div>

  <div class="right-pane">
    <div class="summary-card" id="exportSummary">
      <h3>Project Summary</h3>
      <div class="summary-content">
        <p><strong>Filaments:</strong> <span id="sumFilaments">—</span></p>
        <p><strong>Grid Sequences:</strong> <span id="sumSequences">—</span></p>
        <p><strong>Scans:</strong> <span id="sumScans">—</span></p>
        <p><strong>Image:</strong> <span id="sumImage">—</span></p>
        <p><strong>Model Meshes:</strong> <span id="sumMeshes">—</span></p>
        <div class="swatch-row" id="sumSwatches"></div>
      </div>
      <div class="nav-links">
        <button class="btn-text" data-nav="grid">← Back to Grid</button>
        <button class="btn-text" data-nav="scan">← Back to Scan</button>
        <button class="btn-text" data-nav="model-builder">← Back to Model</button>
      </div>
    </div>
  </div>
</div>

<!-- TAB 6: DOCS -->
<div class="tab-view" id="tab-docs">
  <div class="right-pane" style="grid-column: 1 / -1;">
    <div class="docs-content" id="docsContent">
      <h1>4-Colour FDM Workflow Documentation</h1>

      <h2 id="overview">Overview</h2>
      <p>This application helps you create multi-colour FDM prints using a calibration-based workflow.</p>

      <h2 id="workflow">Workflow</h2>
      <ol>
        <li><strong>Grid:</strong> Generate a calibration grid with all colour combinations</li>
        <li><strong>Scan:</strong> Print and scan the grid to extract actual colours</li>
        <li><strong>Image Process:</strong> Quantize your artwork to the scanned palette</li>
        <li><strong>Model Builder:</strong> Convert to 3D models with height mapping</li>
        <li><strong>Export:</strong> Export STL files ready for printing</li>
      </ol>

      <h2 id="grid-tab">Grid Tab</h2>
      <p>The Grid tab generates all possible colour combinations for your selected filaments...</p>

      <h2 id="scan-tab">Scan Tab</h2>
      <p>After printing the calibration grid, scan it and upload here...</p>

      <h2 id="image-process-tab">Image Process Tab</h2>
      <p>Upload raster or vector artwork to process...</p>

      <h2 id="model-builder-tab">Model Builder Tab</h2>
      <p>Generate 3D models from processed images...</p>

      <h2 id="export-tab">Export Tab</h2>
      <p>Export your final STL files and project data...</p>
    </div>
  </div>
</div>

<!-- Popup for sequence details -->
<div class="popup" id="popup">
  <button class="btn-close" id="closePopup">×</button>
  <h4>Sequence Details</h4>
  <div class="popup-content" id="popupContent"></div>
</div>

<!-- Hidden canvases for processing -->
<canvas id="workCanvas" style="display:none"></canvas>

<!-- Scripts -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.3.0/model-viewer.min.js"></script>
<script type="module" src="app.js"></script>

</body>
</html>
